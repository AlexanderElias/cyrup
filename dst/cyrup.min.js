/*
    Name: cyrup
    Version: 0.7.8
    License: MPL-2.0
    Author: Alexander Elias
    Email: alex.steven.elias@gmail.com
    This Source Code Form is subject to the terms of the Mozilla Public
    License, v. 2.0. If a copy of the MPL was not distributed with this
    file, You can obtain one at http://mozilla.org/MPL/2.0/.
*/
var _slicedToArray=function(){function a(a,b){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!(b&&c.length===b));d=!0);}catch(a){e=!0,f=a}finally{try{!d&&h["return"]&&h["return"]()}finally{if(e)throw f}}return c}return function(b,c){if(Array.isArray(b))return b;if(Symbol.iterator in Object(b))return a(b,c);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_async=function(){try{if(isNaN.apply(null,{}))return function(a){return function(){try{return Promise.resolve(a.apply(this,arguments))}catch(a){return Promise.reject(a)}}}}catch(a){}return function(a){return function(){for(var b=[],c=0;c<arguments.length;c++)b[c]=arguments[c];try{return Promise.resolve(a.apply(this,b))}catch(a){return Promise.reject(a)}}}}();function _await(a,b,c){return c?b?b(a):a:(a=Promise.resolve(a),b?a.then(b):a)}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}(function(a,b){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?module.exports=b():"function"==typeof define&&define.amd?define("Cyrup",b):a.Cyrup=b()})(this,function(){"use strict";var a=function(){function a(){var b=this,c=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,a);var d=c.allows,e=c.denies,f=c.requires,g=c.action,h=c.resource,i=c.behavior;if(this._edit=!0,this._action=null,this._resource=null,this._behavior=null,this._allows=[],this._denies=[],this._requires={},"action"in c&&this.action(g),"resource"in c&&this.resource(h),"behavior"in c&&this.behavior(i),"allows"in c){if(!1==d instanceof Array)throw new Error("permission allows illegal type");d.forEach(function(a){return b.allow(a)})}if("denies"in c){if(!1==e instanceof Array)throw new Error("permission denies illegal type");e.forEach(function(a){return b.deny(a)})}if("requires"in c){if(!1==f instanceof Object)throw new Error("permission requires illegal type");Object.entries(f).forEach(function(a){var c=_slicedToArray(a,2),d=c[0],e=c[1];return b.require(d,e)})}}return _createClass(a,[{key:"edit",value:function(a){if(void 0===a)return this._edit;if("boolean"!=typeof a)throw new Error("permission edit boolean required");return this._edit=a,this}},{key:"action",value:function(a){if(void 0===a)return this._action;if("string"!=typeof a)throw new Error("permission action string required");return this._action=a,this}},{key:"resource",value:function(a){if(void 0===a)return this._resource;if("string"!=typeof a)throw new Error("permission resource string required");return this._resource=a,this}},{key:"behavior",value:function(a){if(void 0===a)return this._behavior;if("boolean"!=typeof a)throw new Error("permission behavior boolean required");return this._behavior=a,this}},{key:"allows",value:function(){return Object.freeze(this._allows)}},{key:"allow",value:function(a){if("string"!=typeof a)throw new Error("permission allow string required");var b=this._allows.includes(a);if(b)throw new Error("permission allow "+a+" exists");return this._allows.push(a),this}},{key:"denies",value:function(){return Object.freeze(this._deniess)}},{key:"deny",value:function(a){if("string"!=typeof a)throw new Error("permission deny string required");var b=this._denies.includes(a);if(b)throw new Error("permission deny "+a+" exists");return this._denies.push(a),this}},{key:"requires",value:function(){return Object.freeze(this._requires)}},{key:"require",value:function(a,b){if("string"!=typeof a)throw new Error("permission name string required");if(!("boolean"!=typeof b||"number"!=typeof b||"string"!=typeof b||b instanceof Array))throw new Error("permission value string or array required");return this._requires[a]=b,this}},{key:"traverse",value:function(a,b){var c=a.split("."),d=c.pop();return c.forEach(function(a){return b=b[a]}),[d,b]}},{key:"validate",value:function(a,b,c){if("object"!==("undefined"==typeof c?"undefined":_typeof(c)))return!1;if("string"!=typeof b)return!1;if("string"!=typeof a)return!1;if(this._action!==b)return!1;if(this._resource!==a)return!1;for(var d in this._requires){var e=this.traverse(d,c),f=_slicedToArray(e,2),g=f[0],h=f[1],i=this._requires[g],j=h[g];if(!(g in h))return!1;if(i instanceof Array&&i.includes(j)||i===j)continue;else return!1}if(this._behavior){var k=!0,l=!1,m=void 0;try{for(var n,o=this._denies[Symbol.iterator]();!(k=(n=o.next()).done);k=!0){var p=n.value,q=this.traverse(p,c),r=_slicedToArray(q,2),s=r[0],t=r[1];if(s in t)return!1;continue}}catch(a){l=!0,m=a}finally{try{!k&&o.return&&o.return()}finally{if(l)throw m}}}else{var u=!0,v=!1,w=void 0;try{for(var x,y=this._allows[Symbol.iterator]();!(u=(x=y.next()).done);u=!0){var z=x.value,A=this.traverse(z,c),B=_slicedToArray(A,2),C=B[0],D=B[1];if(C in D)return!1;continue}}catch(a){v=!0,w=a}finally{try{!u&&y.return&&y.return()}finally{if(v)throw w}}}return!0}},{key:"valid",value:function(){return"string"==typeof this._action&&"string"==typeof this._resource&&"boolean"==typeof this._behavior}},{key:"toJSON",value:function(){return{edit:this._edit,action:this._action,resource:this._resource,behavior:this._behavior,allows:this._allows,denies:this._denies,requires:this._requires}}}]),a}(),b=function(){function b(){var a=this,c=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,b);var d=c.name,e=c.active,f=c.permissions;if(this._edit=!0,this._name=null,this._active=null,this._permissions=[],"name"in c&&this.name(d),"active"in c&&this.active(e),"permissions"in c){if(!1==f instanceof Array)throw new Error("role permissions illegal type");f.forEach(function(b){return a.permission(b)})}}return _createClass(b,[{key:"edit",value:function(a){if(void 0===a)return this._edit;if("boolean"!=typeof a)throw new Error("role edit boolean required");return this._edit=a,this}},{key:"name",value:function(a){if(void 0===a)return this._name;if("string"!=typeof a)throw new Error("role name string required");return this._name=a,this}},{key:"active",value:function(a){if(void 0===a)return this._active;if("boolean"!=typeof a)throw new Error("role active boolean required");return this._active=a,this}},{key:"permissions",value:function(){return Object.freeze(this._permissions)}},{key:"permission",value:function(){var b=new(Function.prototype.bind.apply(a,[null].concat(Array.prototype.slice.call(arguments))));return this.add(b),b}},{key:"get",value:function(a,b){return this._permissions.find(function(c){return c.action()===b&&c.resource()===a})}},{key:"add",value:function(b){if(!1==b instanceof a)throw new Error("role add requires permission");var c=b.action(),d=b.resource(),e=this._permissions.find(function(a){var b=a._resource,e=a._action;return b===d&&e===c});if(e)throw new Error("role add permission "+d+" "+c+" exists");return this._permissions.push(b),this}},{key:"validate",value:function(a,b,c){if("object"!==("undefined"==typeof c?"undefined":_typeof(c)))return!1;if("string"!=typeof b)return!1;if("string"!=typeof a)return!1;if(!1===this._active)return!1;var d=this.get(a,b);return!!d&&d.validate(a,b,c)}},{key:"valid",value:function(){if("string"!=typeof this._name)return!1;if("boolean"!=typeof this._active)return!1;var a=!0,b=!1,c=void 0;try{for(var d,e,f=this._permissions[Symbol.iterator]();!(a=(d=f.next()).done);a=!0)if(e=d.value,!1===e.valid())return!1}catch(a){b=!0,c=a}finally{try{!a&&f.return&&f.return()}finally{if(b)throw c}}return!0}},{key:"toJSON",value:function(){return{edit:this._edit,name:this._name,active:this._active,permissions:this._permissions.map(function(a){return a.toJSON()})}}}]),b}(),c=function(){function a(){var b=this,c=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,a);var d=c.roles;if(this._roles={},"roles"in c){if(!1==d instanceof Array)throw new Error("access roles illegal type");d.forEach(function(a){return b.role(a)})}}return _createClass(a,[{key:"role",value:function(){var a=new(Function.prototype.bind.apply(b,[null].concat(Array.prototype.slice.call(arguments))));return this.add(a),a}},{key:"get",value:function(a){if(!1==a instanceof b)throw new Error("access get requires role");var c=a.name();return this._roles[c]}},{key:"add",value:function(a){if(!1==a instanceof b)throw new Error("access add requires role");var c=a.name(),d=c in this._roles;if(d)throw new Error("access add role "+c+" exists");return this._roles[c]=a,this}},{key:"remove",value:function(a){if(!1==a instanceof b)throw new Error("access remove requires role");var c=a.name(),d=c in this._roles;if(d)throw new Error("access remove role "+c+" exists");return delete this._roles[c],this}},{key:"roles",value:function(){return Object.freeze(this._roles)}},{key:"toJSON",value:function(){return this._roles}}]),a}(),d={ENCODING:"hex",ITERATIONS:999999,KEY:32,TAG:16,SALT:16,VECTOR:12,RANDOM:20,HASH:"sha-512",ALGORITHM:"aes-256-gcm",Role:b,Access:c,Permission:a,role:function(){return new(Function.prototype.bind.apply(b,[null].concat(Array.prototype.slice.call(arguments))))},access:function(){return new(Function.prototype.bind.apply(c,[null].concat(Array.prototype.slice.call(arguments))))},permission:function(){return new(Function.prototype.bind.apply(a,[null].concat(Array.prototype.slice.call(arguments))))},random:_async(function(a){var b=this,c=b;return a=a||c.RANDOM,_await(c.randomBytes(a),function(a){return _await(c.bufferToHex(a))})}),hash:_async(function(a,b){var c=this,d=c;if(!a)throw new Error("Cyrup.hash - item argument required");return b=d.normalizeHash(b||d.HASH),_await(d.stringToBuffer(a),function(a){return _await(d.createHash(a,b),function(a){return _await(d.bufferToHex(a))})})}),compare:_async(function(a,b){var c=this,d=c;if(!b)throw new Error("Cyrup.compare - key argument required");if(!a)throw new Error("Cyrup.compare - password argument required");return _await(d.hexToBuffer(b.split(":")[1]),function(c){return _await(d.key(a,{salt:c}),function(a){return a===b})})}),key:_async(function(a,b){var c=this,d=c;if(!a)throw new Error("Cyrup.key - item argument required");return b=b||{},b.size=b.size||d.KEY,b.salt=b.salt||d.SALT,b.iterations=b.iterations||d.ITERATIONS,b.hash=d.normalizeHash(b.hash||d.HASH),_await(Promise.all(["string"==typeof a?d.stringToBuffer(a):a,"string"==typeof b.salt?d.stringToBuffer(b.salt):"number"==typeof b.salt?d.randomBytes(b.salt):b.salt]),function(a){var c=_slicedToArray(a,2),e=c[0],f=c[1];return _await(d.pbkdf2(e,f,b.iterations,b.size,b.hash),function(a){return _await(Promise.all([d.bufferToHex(a),d.bufferToHex(f)]),function(a){var b=_slicedToArray(a,2),c=b[0],d=b[1];return c+":"+d})})})}),encrypt:_async(function(a,b,c,d){var e=this,f=e;if(!b)throw new Error("Cyrup.encrypt - key argument required");if(!a)throw new Error("Cyrup.encrypt - data argument required");return b=b.split(":"),d=d||f.VECTOR,c=f.normalizeAlgorithm(c||f.ALGORITHM),_await(Promise.all([f.hexToBuffer(b[0]),"string"==typeof a?f.stringToBuffer(a):a,"string"==typeof d?f.stringToBuffer(d):f.randomBytes(d)]),function(a){var b=_slicedToArray(a,3),d=b[0],e=b[1],g=b[2];return _await(f.cipher(c,d,g,e),function(a){return _await(Promise.all([f.bufferToHex(a),f.bufferToHex(g)]),function(a){var b=_slicedToArray(a,2),c=b[0],d=b[1];return c+":"+d})})})}),decrypt:_async(function(a,b,c){var d=this,e=d;if(!b)throw new Error("Cyrup.decrypt - key argument required");if(!a)throw new Error("Cyrup.decrypt - data argument required");return c=e.normalizeAlgorithm(c||e.ALGORITHM),b=b.split(":"),a=a.split(":"),_await(Promise.all([e.hexToBuffer(b[0]),e.hexToBuffer(a[0]),e.hexToBuffer(a[1])]),function(a){var b=_slicedToArray(a,3),d=b[0],f=b[1],g=b[2];return _await(e.decipher(c,d,g,f),function(a){return _await(e.bufferToString(a))})})})};if("undefined"==typeof window){var e=require("util"),f=require("crypto"),g=e.promisify(f.pbkdf2),h=e.promisify(f.randomBytes);d.normalizeHash=function(a){return a.replace("-","").toLowerCase()},d.normalizeAlgorithm=function(a){return 0===a.toLowerCase().indexOf("aes")?a.toLowerCase():a},d.hexToBuffer=_async(function(a){return Buffer.from(a,"hex")}),d.bufferToHex=_async(function(a){return a.toString("hex")}),d.stringToBuffer=_async(function(a){return Buffer.from(a,"utf8")}),d.bufferToString=_async(function(a){return a.toString("utf8")}),d.createHash=_async(function(a,b){return f.createHash(b).update(a).digest()}),d.randomBytes=_async(function(a){return h(a)}),d.pbkdf2=_async(function(a,b,c,d,e){return g(a,b,c,d,e)}),d.cipher=_async(function(a,b,c,d){var e=f.createCipheriv(a,b,c);return Buffer.concat([e.update(d,"utf8"),e.final(),e.getAuthTag()])}),d.decipher=_async(function(a,b,c,d){var e=this,g=e,h=Buffer.from(d,"hex"),i=h.slice(h.byteLength-g.TAG),j=h.slice(0,h.byteLength-g.TAG),k=f.createDecipheriv(a,b,c);return k.setAuthTag(i),Buffer.concat([k.update(j),k.final()])})}else d.normalizeHash=function(a){return a.toUpperCase()},d.normalizeAlgorithm=function(a){if(0!==a.toLowerCase().indexOf("aes"))return a;var b=a.split("-");return(b[0]+"-"+b[2]).toUpperCase()},d.getAuthTag=function(a){return a.slice(a.byteLength-this.TAG)},d.hexToBuffer=_async(function(a){if("string"!=typeof a)throw new TypeError("Cyrup.hexToBuffer - expected input to be a string");if(0!=a.length%2)throw new RangeError("Cyrup.hexToBuffer - expected string to be an even number of characters");for(var b=new Uint8Array(a.length/2),c=0,d=a.length;c<d;c+=2)b[c/2]=parseInt(a.substring(c,c+2),16);return b.buffer}),d.bufferToHex=_async(function(a){for(var b=new Uint8Array(a),c=Array(b.length),d=0,e=b.length;d<e;d++)c[d]=("00"+b[d].toString(16)).slice(-2);return c.join("")}),d.stringToBuffer=_async(function(a){for(var b=new Uint8Array(a.length),c=0,d=a.length;c<d;c++)b[c]=a.charCodeAt(c);return b.buffer}),d.bufferToString=_async(function(a){for(var b=new Uint8Array(a),c=Array(b.length),d=0,e=b.length;d<e;d++)c[d]=String.fromCharCode(b[d]);return c.join("")}),d.createHash=_async(function(a,b){return window.crypto.subtle.digest(b,a)}),d.randomBytes=_async(function(a){return window.crypto.getRandomValues(new Uint8Array(a))}),d.pbkdf2=_async(function(a,b,c,d,e){return _await(window.crypto.subtle.importKey("raw",a,{name:"PBKDF2"},!1,["deriveBits"]),function(a){return _await(window.crypto.subtle.deriveBits({salt:b,iterations:c,name:"PBKDF2",hash:{name:e}},a,d<<3),function(a){return new Uint8Array(a)})})}),d.cipher=_async(function(a,b,c,d){var e=this;return _await(window.crypto.subtle.importKey("raw",b,{name:a},!1,["encrypt"]),function(b){return _await(window.crypto.subtle.encrypt({iv:c,name:a,tagLength:8*e.TAG},b,d))})}),d.decipher=_async(function(a,b,c,d){var e=this;return _await(window.crypto.subtle.importKey("raw",b,{name:a},!1,["decrypt"]),function(b){return _await(window.crypto.subtle.decrypt({iv:c,name:a,tagLength:8*e.TAG},b,d))})});return d});