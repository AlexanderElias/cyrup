/*
	Name: cyrup
	Version: 0.1.0
	License: MPL-2.0
	Author: Alexander Elias
	Email: alex.steven.elias@gmail.com
	This Source Code Form is subject to the terms of the Mozilla Public
	License, v. 2.0. If a copy of the MPL was not distributed with this
	file, You can obtain one at http://mozilla.org/MPL/2.0/.
*/
var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a};function _asyncToGenerator(a){return function(){var b=a.apply(this,arguments);return new Promise(function(a,c){function d(e,f){try{var g=b[e](f),h=g.value}catch(a){return void c(a)}return g.done?void a(h):Promise.resolve(h).then(function(a){d("next",a)},function(a){d("throw",a)})}return d("next")})}}(function(a,b){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?module.exports=b():"function"==typeof define&&define.amd?define("Cyrup",b):a.Cyrup=b()})(this,function(){"use strict";var a={ENCODING:"hex",ITERATIONS:99999,TAG_BYTES:16,KEY_BYTES:32,SALT_BYTES:16,VECTOR_BYTES:12,SECRET_BYTES:48,HASH:"sha-512",ALGORITHM:"aes-256-gcm",normalizeBytes:function(a){var b=this;if("number"==typeof a)return a;if(0!==a.toLowerCase().indexOf("aes"))return b.KEY_BYTES;var c=a.split("-"),d=parseInt(c[1]);return d===NaN?8*b.KEY_BYTES:d/8},random:function(a){var b=this;return a=a||{},Promise.resolve().then(function(){return b.randomBytes(a.bytes)}).then(function(a){return b.bufferToHex(a)})},secret:function(a){var b=this;return a=a||{},a.bytes=a.bytes||b.SECRET_BYTES,Promise.resolve().then(function(){return b.randomBytes(a.bytes)}).then(function(a){return b.bufferToHex(a)})},hash:function(a){var b=this;if(!a.item)throw new Error("item required");return a=a||{},a.hash=a.hash||b.HASH,a.hash=b.normalizeHash(a.hash),Promise.resolve().then(function(){return b.stringToBuffer(a.item)}).then(function(c){return b.createHash(c,a.hash)}).then(function(a){return b.bufferToHex(a)})},encrypt:function(a){var b=this;if(a=a||{},!a.item)throw new Error("item required");if(!a.password)throw new Error("password required");a.hash=a.hash||b.HASH,a.algorithm=a.algorithm||b.ALGORITHM,a.bytes=a.bytes||a.algorithm,a.iterations=a.iterations||b.ITERATIONS,a.saltBytes=a.saltBytes||b.SALT_BYTES,a.vectorBytes=a.vectorBytes||b.VECTOR_BYTES,a.hash=b.normalizeHash(a.hash),a.bytes=b.normalizeBytes(a.bytes),a.algorithm=b.normalizeAlgorithm(a.algorithm);var c,d,e,f;return Promise.all([b.stringToBuffer(a.item),b.randomBytes(a.saltBytes),b.randomBytes(a.vectorBytes),b.stringToBuffer(a.password)]).then(function(a){d=a[0],c=a[1],e=a[2],f=a[3]}).then(function(){return b.pbkdf2(f,c,a.iterations,a.bytes,a.hash,a.algorithm)}).then(function(c){return b.cipher(a.algorithm,c,e,d)}).then(function(a){return Promise.all([b.bufferToHex(a),b.bufferToHex(e),b.bufferToHex(c)]).then(function(a){return a.join(":")})})},decrypt:function(a){var b=this;if(a=a||{},!a.item)throw new Error("item required");if(!a.password)throw new Error("password required");a.hash=a.hash||b.HASH,a.algorithm=a.algorithm||b.ALGORITHM,a.bytes=a.bytes||a.algorithm,a.iterations=a.iterations||b.ITERATIONS,a.saltBytes=a.saltBytes||b.SALT_BYTES,a.vectorBytes=a.vectorBytes||b.VECTOR_BYTES,a.hash=b.normalizeHash(a.hash),a.bytes=b.normalizeBytes(a.bytes),a.algorithm=b.normalizeAlgorithm(a.algorithm);var c=a.item.split(":"),d=c[0],e=c[1],f=c[2],g=void 0,h=void 0,i=void 0,j=void 0;return Promise.all([b.hexToBuffer(d),b.hexToBuffer(f),b.hexToBuffer(e),b.stringToBuffer(a.password)]).then(function(a){h=a[0],g=a[1],i=a[2],j=a[3]}).then(function(){return b.pbkdf2(j,g,a.iterations,a.bytes,a.hash,a.algorithm)}).then(function(c){return b.decipher(a.algorithm,c,i,h)}).then(function(a){return b.bufferToString(a)})}};if("undefined"==typeof window){var b=require("util"),c=require("crypto"),d=b.promisify(c.pbkdf2),e=b.promisify(c.randomBytes);a.normalizeHash=function(a){return a.replace("-","").toLowerCase()},a.normalizeAlgorithm=function(a){return 0===a.toLowerCase().indexOf("aes")?a.toLowerCase():a},a.hexToBuffer=function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",Buffer.from(b,"hex"));case 1:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}(),a.bufferToHex=function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",b.toString("hex"));case 1:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}(),a.stringToBuffer=function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",Buffer.from(b,"utf8"));case 1:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}(),a.bufferToString=function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",b.toString("utf8"));case 1:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}(),a.createHash=function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b,d){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",c.createHash(d).update(b).digest());case 1:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}(),a.randomBytes=function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",e(b));case 1:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}(),a.pbkdf2=function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b,c,e,f,g){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",d(b,c,e,f,g));case 1:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}(),a.cipher=function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b,d,e,f){var g,h;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return g=this,h=c.createCipheriv(b,d,e),a.abrupt("return",Buffer.concat([h.update(f,"utf8"),h.final(),h.getAuthTag()]));case 3:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}(),a.decipher=function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b,d,e,f){var g,h,i,j,k;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return g=this,h=Buffer.from(f,"hex"),i=h.slice(h.byteLength-g.TAG_BYTES),j=h.slice(0,h.byteLength-g.TAG_BYTES),k=c.createDecipheriv(b,d,e),k.setAuthTag(i),a.abrupt("return",Buffer.concat([k.update(j),k.final()]));case 7:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()}else a.normalizeHash=function(a){return a.toUpperCase()},a.normalizeAlgorithm=function(a){if(0!==a.toLowerCase().indexOf("aes"))return a;var b=a.split("-");return(b[0]+"-"+b[2]).toUpperCase()},a.getAuthTag=function(a){return a.slice(a.byteLength-this.TAG_BYTES)},a.hexToBuffer=function(a){return Promise.resolve().then(function(){if("string"!=typeof a)throw new TypeError("Expected input to be a string");if(0!=a.length%2)throw new RangeError("Expected string to be an even number of characters");for(var b=new Uint8Array(a.length/2),c=0,d=a.length;c<d;c+=2)b[c/2]=parseInt(a.substring(c,c+2),16);return b.buffer})},a.bufferToHex=function(a){return Promise.resolve().then(function(){for(var b=new Uint8Array(a),c=Array(b.length),d=0,e=b.length;d<e;d++)c[d]=("00"+b[d].toString(16)).slice(-2);return c.join("")})},a.stringToBuffer=function(a){return Promise.resolve().then(function(){for(var b=new Uint8Array(a.length),c=0,d=a.length;c<d;c++)b[c]=a.charCodeAt(c);return b.buffer})},a.bufferToString=function(a){return Promise.resolve().then(function(){for(var b=new Uint8Array(a),c=Array(b.length),d=0,e=b.length;d<e;d++)c[d]=String.fromCharCode(b[d]);return c.join("")})},a.createHash=function(a,b){return Promise.resolve().then(function(){return window.crypto.subtle.digest(b,a)})},a.randomBytes=function(a){return Promise.resolve().then(function(){return window.crypto.getRandomValues(new Uint8Array(a))})},a.pbkdf2=function(a,b,c,d,e,f){var g=this;return Promise.resolve().then(function(){if(!b)throw new Error("salt required");if(!e)throw new Error("hash required");if(!d)throw new Error("bytes required");if(!a)throw new Error("password required");if(!f)throw new Error("algorithm required");if(!c)throw new Error("iterations required")}).then(function(){return window.crypto.subtle.importKey("raw",a,{name:"PBKDF2"},!1,["deriveBits","deriveKey"])}).then(function(a){return window.crypto.subtle.deriveKey({salt:b,hash:e,iterations:c,name:"PBKDF2"},a,{name:f,length:8*d,tagLength:8*g.TAG_BYTES},!1,["encrypt","decrypt"])})},a.cipher=function(a,b,c,d){return Promise.resolve().then(function(){return window.crypto.subtle.encrypt({name:a,iv:c},b,d)})},a.decipher=function(a,b,c,d){return Promise.resolve().then(function(){return window.crypto.subtle.decrypt({name:a,iv:c},b,d)})};return a});